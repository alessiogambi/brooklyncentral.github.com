<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
  <title>Writing YAML Blueprints</title>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />

  <link rel="stylesheet" href="/v/0.7.0-SNAPSHOT/style/style.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/v/0.7.0-SNAPSHOT/style/toc.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/v/0.7.0-SNAPSHOT/style/docs/code.css" type="text/css" media="screen" />

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  
	<!-- Sidebar/ToC Scripts and CSS -->
	<script src="/v/0.7.0-SNAPSHOT/style/js/jquery/jquery-1.7.1.min.js"></script>
	<script src="/v/0.7.0-SNAPSHOT/style/js/jquery/jquery-ui-1.8.18.custom.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/v/0.7.0-SNAPSHOT/style/js/jquery/smoothness/jquery-ui-1.8.18.custom.css" />
	
	<script type="text/javascript" src="/v/0.7.0-SNAPSHOT/style/js/superfish.js"></script>
	<script type="text/javascript" src="/v/0.7.0-SNAPSHOT/style/js/jquery.cookie.js"></script>
	
	
<!-- Clipboard support -->
<script src="/v/0.7.0-SNAPSHOT/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<style type="text/css">
.clipboard_container { float: right; padding: 8px; }
.clipboard_button {
    background-image: url("/v/0.7.0-SNAPSHOT/style/icons/clipboard-green-normal.png");
    background-size: 18px 21px;
    width: 18px; height: 21px;
}
.clipboard_button:hover, .clipboard_button.zeroclipboard-is-hover { background-image: url("/v/0.7.0-SNAPSHOT/style/icons/clipboard-green-hover.png"); }
.clipboard_button:active, .clipboard_button.zeroclipboard-is-active { background-image: url("/v/0.7.0-SNAPSHOT/style/icons/clipboard-green-click.png"); }'
</style>
<script type="text/javascript"> <!-- clipboard -->
  ZeroClipboard.config({ moviePath: '/v/0.7.0-SNAPSHOT/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script type="text/javascript"> <!-- clipboard positioning -->
$(document).ready(function() {
  $('<div class="clipboard_container" title="Copy to Clipboard">'+
    '<div class="clipboard_button"/>'+
  '</div>').insertBefore($('div.highlight'))
  $('div.clipboard_container').each(function(index) {
    var clipboard = new ZeroClipboard();
    clipboard.clip( $(this).find(":first")[0], $(this)[0] );
    var target = $(this).next();
    var txt = target.text().trim();
    if (target.find('code.bash')) {
      // Strip out bash prompts from the start of each line (i.e. '$' or '%' characters
      // at the very start, or immediately following any newline). Correctly handles continuation
      // lines, where a leading '$' or '%' is *not* a prompt character.
      txt = txt.replace(/(^|[^\\]\n)[$%] /g, "$1");
    }
console.log("setting text to "+txt);
    clipboard.on( 'dataRequested', function (client, args) {
      client.setText( txt );
    });
  });
});
</script>

    <script type="text/javascript">
        // initialise menu delay
        jQuery(function(){
            jQuery('ul#mainmenu').superfish({ 
                autoArrows:  false,  // disable generation of arrow mark-up 
                dropShadows: false,  // disable drop shadows 
                disableHI:   true,   // set to true to disable hoverIntent detection 
                delay:       500,    // the delay in milliseconds that the mouse can remain outside a submenu without it closing 
                speed:       'fast', 
            });
        });
    </script>

<script type="text/javascript">

<!-- search -->
	$(function() {
		$('#simple_google')
			.submit(function() {
				$('input[name="q"]').val("site:" + document.location.hostname + " " + $('input[name="brooklyn-search"]').val());
			return true;
			});
		$('input[name="brooklyn-search"]').focus(function() {
				if ($(this).val() === $(this).attr('placeholder')) {
					$(this).val('');
				}
			})
			.blur(function() {
				if ($(this).val() === '') {
					$(this).val($(this).attr('placeholder'));
				}
			})
			.blur();
    });
    
<!-- page notes -->
   	$(function() {
		if (document.location.pathname.replace(/^\/([^\/]*).*$/, '$1') === "v"){
			var thisversion = document.location.pathname.split("/")[2],
				msg = "";
			
			if (!$.cookie('brooklyn_versions') || 
			        (($.inArray('ALL', $.cookie('brooklyn_versions').split(",")) === -1) &&
			        ($.inArray(thisversion, $.cookie('brooklyn_versions').split(",")) === -1)) ){
			    msg += "<div class='warning_banner_image'><img src='/v/0.7.0-SNAPSHOT/style/icons/warning.png'/></div>";
				msg += "<p>This content is for <strong>Brooklyn "+thisversion+"</strong>, and may differ across versions.</p>";
			    msg += "<p>Are you using version "+thisversion+"?</p>";
				msg += "<p class='warning_banner_buttons'>";
				msg += "<a href = '#' onclick=\"set_user_version('"+thisversion+"');\">Yes, hide this warning</a>";
			    msg += "<a href = '/'>No, show me the latest version</a>";
				msg += "<a href = '/meta/versions.html'>Show all versions</a>";
				msg += "</p>"
							
				$('#page_notes').html(msg);
				$('#page_notes').fadeIn('slow');
			}
		}
	});
   	function get_user_versions() {
   	    return $.cookie("brooklyn_versions") ? $.cookie("brooklyn_versions").split(",") : [];
   	};
	function set_user_version(version) {
		var version_cookie = get_user_versions();
		version_cookie.push(version);
		$.cookie('brooklyn_versions', version_cookie, { expires: 365, path: '/' });
		$('#page_notes').fadeOut();
		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	};
    function set_user_versions_all() {
        var version_cookie = get_user_versions();
        version_cookie.push("ALL");
        $.cookie('brooklyn_versions', version_cookie, { expires: 365, path: '/' });
        $('#page_notes').fadeOut();
        event.preventDefault ? event.preventDefault() : event.returnValue = false;
    };
    function clear_user_versions() {
        $.removeCookie('brooklyn_versions', { path: '/' });
        $('#page_notes').fadeIn('slow');
        event.preventDefault ? event.preventDefault() : event.returnValue = false;
    };
	
   
 <!-- analytics -->
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-30530918-1']);
	_gaq.push(['_trackPageview']);
	
	(function() {
	  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

</head>

<body>

    <ul id="shortcuts" title="Accessibility shortcuts menu">
        <li><a href="#maincontent">Skip to main content</a></li>
    </ul>
   

<div id="container">

    <div id="header">
    
        <div id="identity">
            <a href="http://brooklyncentral.github.com/" rel="home">Brooklyn</a>
        </div>
        
        <ul id="quicklinks">
            <li><a href="/v/0.7.0-SNAPSHOT/meta/versions.html">0.7.0-SNAPSHOT</a></li>
            <li><a href="/v/0.7.0-SNAPSHOT/start/download.html">Download</a></li>
            <li><a href="https://github.com/brooklyncentral">GitHub</a></li>
            <li><a href="https://twitter.com/#!/search?q=brooklyncentral">Twitter</a></li>
            <li><a href="/v/0.7.0-SNAPSHOT/meta/contact.html">Contact</a></li>
        </ul>

        <div id="menubar">  







<ul id="mainmenu"><!-- INSERT LINKS -->
            

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/index.html">Overview</a></li>

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/start/download.html">Download</a></li>

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/use/guide/quickstart/index.html">Getting Started</a></li>

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/start/walkthrough/index.html">Walkthrough</a></li>

  
  
  <li class="toc-active"><a href="/v/0.7.0-SNAPSHOT/use/guide/index.html">User Guide</a></li>

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/use/examples/index.html">Examples</a></li>

  
  
  <li class=""><a href="/v/0.7.0-SNAPSHOT/dev/code/index.html">Contributing</a></li>


</ul>                    

            <form method="get" id="simple_google" class="searchform" action="http://www.google.com/search" method="get">
                <input type="text" class="searchinput" name="brooklyn-search" placeholder="Search: type &amp; hit enter" />
                <input type="hidden" name="q" value="" />
            </form>
            
        </div>
                
    </div><!--header-->
    
    <div id="contentcontainer">
    
        <div id="maincontent">


  







    
    

    
    
        
        
    
        
        
            
        
            
        
            
        
            
                
                
                
                
                
                
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
        
            
        
            
        
            
        
            
        
            
        
    
        
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
    



            
<p id="breadcrumb">
    <a href="/v/0.7.0-SNAPSHOT/use/guide/index.html">User Guide</a>
    
        &raquo; <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/basic-concepts.html">Defining Applications</a>
        
            &raquo; <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/creating-yaml.html">YAML Blueprints</a>
        
    
</p>


<div id="page_notes"></div>

<h1 id="header_title">Writing YAML Blueprints</h1>
    
<h2>A First Blueprint</h2>

<p>The easiest way to write a blueprint is as a YAML file.
This follows the  <a href="https://www.oasis-open.org/committees/camp/">OASIS CAMP</a> plan specification,
with some extensions described below.
(A <a href="yaml-reference.html">YAML reference</a> has more information,
and if the YAML doesn't yet do what you want,
it's easy to add new extensions using your favorite JVM language.)</p>

<h3>The Basic Structure</h3>

<p>Here's a very simple YAML blueprint plan, to explain the structure:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
</code></pre>
</div>


<ul>
<li><p>The <code>name</code> is just for the benefit of us humans.</p></li>
<li><p>The <code>location</code> specifies where this should be deployed.
If you've <a href="/v/0.7.0-SNAPSHOT/use/guide/locations/">set up passwordless localhost SSH access</a>
you can use <code>localhost</code> as above, but if not, just wait ten seconds for the next example.</p></li>
<li><p>The <code>services</code> block takes a list of the typed services we want to deploy.
This is the meat of the blueprint plan, as you'll see below.</p></li>
</ul>


<p>Finally, that clipboard in the corner lets you easily copy-and-paste into the web-console:
simply <a href="/v/0.7.0-SNAPSHOT/use/guide/quickstart/">download and launch</a> Brooklyn,
then in the "Add Application" dialog at the web console
(usually <a href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a>.
There are several other ways to deploy, including <code>curl</code> and via the command-line,
and you can configure https and security, and much more, as described <a href="deploying-yaml.html">here</a>.</p>

<p><a href="web-console-yaml.png"><img src="web-console-yaml-700.png" title="YAML via Web Console" alt="Web Console" /></a></p>

<h3>Setting Locations</h3>

<p>Brooklyn supports a very wide range of target locations -- localhost is mainly a convenience for testing.
With deep integration to <a href="http://jclouds.org">Apache jclouds</a>, most well-known clouds and cloud platforms are supported.
The following example is for Amazon EC2:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver-with-location</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:aws-ec2</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">us-east-1</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AKA_YOUR_ACCESS_KEY_ID</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;access-key-hex-digits&gt;</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
</code></pre>
</div>


<p>(You'll need to replace the <code>identity</code> and <code>credential</code> with the
"Access Key ID" and "Secret Access Key" for your account,
as configured in the <a href="https://console.aws.amazon.com/iam/home?#security_credential">AWS Console</a>.)</p>

<p>Other popular public clouds include <code>softlayer</code>, <code>google-compute-engine</code>, and <code>rackspace-cloudservers-us</code>.
Private cloud systems including <code>openstack-nova</code> and <code>cloudstack</code> are also supported,
although for these you'll supply an <code>endpoint: https://9.9.9.9:9999/v2.0/</code>
(or <code>client/api/</code> in the case of CloudStack) instead of the <code>region</code>.</p>

<p>You can also specify pre-existing servers to use -- "bring-your-own-nodes".
These can be a global pool or specific to a service.
Both styles are shown here (though normally only one will be selected,</p>

<!-- TODO see #1377, currently it is *parent* location which is preferred typically -->


<p>
depending on the blueprint):</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver-with-location-byon</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn</span>
    <span class="l-Scalar-Plain">privateKeyFile</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.ssh/brooklyn.pem</span>
    <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.18</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.19</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">hosts</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">127.0.0.1</span> <span class="p-Indicator">]</span> <span class="p-Indicator">}</span>
</code></pre>
</div>


<p>You'll also note in this example that we've used JSON-style notation in the second <code>location</code> block.
YAML supports this, and sometimes that makes more readable plans.
(Although in this case a simple <code>location: localhost</code> is equivalent and even more succinct, but this is a tutorial.)</p>

<p>For more information see the Locations section of the <a href="yaml-reference.html">YAML reference</a>
and in the <a href="/v/0.7.0-SNAPSHOT/use/guide/locations/">User's Guide</a>.
Another good reference is the <a href="/use/guide/quickstart/brooklyn.properties">template brooklyn.properties</a>,
which if you install in <code>~/.brooklyn/brooklyn.properties</code> and edit with your credentials,<br/>
allows you to refer to clouds simply as <code>location: jclouds:aws-ec2:eu-west-1</code> or
set up "named locations" you can use as <code>location: named:my_cloudstack</code>.</p>

<h2>Configuring VMs</h2>

<p>Another simple blueprint will just create a VM which you can use, without any software installed upon it:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-vm</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.basic.EmptySoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VM</span>
  <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8192</span>
    <span class="l-Scalar-Plain">minCores</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
    <span class="l-Scalar-Plain">minDisk</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
</code></pre>
</div>


<p><em>We've omitted the <code>location</code> section here and in many of the examples below;
add the appropriate choice when you paste your YAML. Note that the <code>provisioning.properties</code> will be
ignored if deploying to <code>localhost</code> or <code>byon</code> fixed-IP machines.</em></p>

<p>This will create a VM with the specified parameters in your choice of cloud.
In the GUI (and in the REST API), the entity is called "VM",
and the hostname and IP address(es) are reported as <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/basic-concepts.html">sensors</a>.
There are many more <code>provisioning.properties</code> supported here,
including:</p>

<ul>
<li>a <code>user</code> to create (if not specified it creates the same username as <code>brooklyn</code> is running under)</li>
<li>a <code>password</code> for him or a <code>publicKeyFile</code> and <code>privateKeyFile</code> (defaulting to keys in <code>~/.ssh/id_rsa{.pub,}</code> and no password,
so if you have keys set up you can immediately ssh in!)</li>
<li><code>machineCreateAttempts</code> (for dodgy clouds, and they nearly all fail occasionally!)</li>
<li>and things like <code>imageId</code> and <code>userMetadata</code> and disk and networking options (e.g. <code>autoAssignFloatingIp</code> for private clouds)</li>
</ul>


<p>For more information, see the javadoc on <code>JcloudsLocationConfig</code>.</p>

<h3>Clusters, Specs, and Composition</h3>

<p>What if you want multiple machines?</p>

<p>One way is just to repeat the <code>- type: brooklyn.entity.basic.EmptySoftwareProcess</code> block,
but there's another way which will keep your powder <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a>:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cluster-vm</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">initialSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
  <span class="l-Scalar-Plain">memberSpec</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.basic.EmptySoftwareProcess</span>
      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VM</span>
      <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8192</span>
        <span class="l-Scalar-Plain">minCores</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
        <span class="l-Scalar-Plain">minDisk</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
</code></pre>
</div>


<p>Here we've composed the previous blueprint introducing some new important concepts, the <code>DynamicCluster</code>
the <code>$brooklyn</code> DSL, and the "entity-spec".  Let's unpack these.</p>

<p>The <code>DynamicCluster</code> creates a set of homogeneous instances.
At design-time, you specify an initial size and the specification for the entity it should create.
At runtime you can restart and stop these instances as a group (on the <code>DynamicCluster</code>) or refer to them
individually. You can resize the cluster, attach enrichers which aggregate sensors across the cluster,
and attach policies which, for example, replace failed members or resize the cluster dynamically.</p>

<p>The specification is defined in the <code>memberSpec</code> key.  As you can see it looks very much like the
previous blueprint, with one extra line.  Entries in the blueprint which start with <code>$brooklyn:</code>
refer to the Brooklyn DSL and allow a small amount of logic to be embedded
(if there's a lot of logic, it's recommended to write a blueprint YAML plugin or write the blueprint itself
as a plugin, in Java or a JVM-supported language).</p>

<p>In this case we want to indicate that the parameter to <code>memberSpec</code> is an entity specification
(<code>EntitySpec</code> in the underlying type system); the <code>entitySpec</code> DSL command will do this for us.
The example above thus gives us 5 VMs identical to the one we created in the previous section.</p>

<h2>A Bigger Blueprint</h2>

<p>We've seen the configuration of machines and how to build up clusters.
Now let's return to our app-server example and explore how more interesting
services can be configured, composed, and combined.</p>

<p>Also note there are some good overview materials <a href="/v/0.7.0-SNAPSHOT//use/guide/defining-applications/basic-concepts.html">here</a>
covering clusters, sensors, effectors and more,
if you're the kind of person who likes to learn more about concepts before seeing them in action.</p>

<h3>Service Configuration</h3>

<p>We'll begin by using more key-value pairs to configure the JBoss server to run a real app:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-configured</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">war</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
  <span class="l-Scalar-Plain">httpPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span>
</code></pre>
</div>


<p>(As before, you'll need to add the <code>location</code> info; <code>localhost</code> will work for these and subsequent examples.)</p>

<p>When this is deployed, you can see management information in the Brooklyn Web Console,
including a link to the deployed application (downloaded to the target machine from the <code>hello-world</code> URL),
running on port 8080.</p>

<p><strong>Top tip</strong>:  If port 8080 might be in use, you can specify <code>8080+</code> to take the first available port >= 8080;
the actual port will be reported as a sensor by Brooklyn.</p>

<p>It's also worth indicating an alternate, more formal syntax.
Not all configuration on entities is supported at the top level of the service specification
(only those which are defined as "flags" in the underlying blueprint,
e.g. the <code>@SetFromFlag("war")</code> in the <code>WebAppServiceConstants</code> parent of <code>JBoss7Server</code>).
All configuration has a formal qualified name, and this can be supplied even where flags or config keys are not
explicitly defined, by placing it into a <code>brooklyn.config</code> section:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-configured-in-config</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span>
</code></pre>
</div>


<h3>Multiple Services and Dependency Injection</h3>

<p>If you explored the <code>hello-world-sql</code> application we just deployed,
you'll have noticed it tries to access a database.
And it fails, because we have not set one up.  Let's do that now:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-db</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AppServer HelloWorld</span> 
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
         <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/brooklyncentral/brooklyn/raw/master/usage/launcher/src/test/resources/visitors-creation-script.sql</span>
</code></pre>
</div>


<p>Here there are a few things going on:</p>

<ul>
<li>We've added a second service, which will be the database;
you'll note the database has been configured to run a custom setup script</li>
<li>We've injected the URL of the second service into the appserver as a Java system property
(so our app knows where to find the database)</li>
</ul>


<p><strong>Caution: Be careful if you write your YAML in an editor which attempts to put "smart-quotes" in.
All quote characters must be plain ASCII, not fancy left-double-quotes and right-double-quotes!</strong></p>

<p>There are as many ways to do dependency injection as there are developers,
it sometimes seems; our aim in Brooklyn is not to say this has to be done one way,
but to support the various mechanisms people might need to do, for whatever reasons.
(We each have our opinions about what works well, of course;
the one thing we do want to call out is that being able to dynamically update
the injection is useful in a modern agile application -- so we are definitively <strong>not</strong>
recommending this Java system property approach ... but it is an easy one to demo!)</p>

<p>The way the dependency injection works is again by using the <code>$brooklyn:</code> DSL,
this time referring to the <code>component("db")</code> (looked up by the <code>id</code> field on our DB component),
and then to a sensor emitted by that component.
All the database entities emit a <code>database.url</code> sensor when they are up and running;
the <code>attributeWhenReady</code> DSL method will store a pointer to that sensor (a Java Future under the covers)
in the Java system properties map which the JBoss entity reads at launch time, blocking if needed.</p>

<p>This means that the deployment occurs in parallel, and if the database comes up first,
there is no blocking; but if the JBoss entity completes its installation and
downloading the WAR, it will wait for the database before it launches.
At that point the URL is injected, first passing it through <code>formatString</code>
to include the credentials for the database (which are defined in the database creation script).</p>

<h3>An Aside: Substitutability</h3>

<p>Don't like JBoss?  Is there something about Maria?
One of the modular principles we follow in Brooklyn is substitutability:
in many cases, the config keys, sensors, and effectors are defined
in superclasses and are portable across multiple implementations.</p>

<p>Here's an example deploying the same application but with different flavors of the components:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-db-other-flavor</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.tomcat.TomcatServer</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AppServer HelloWorld</span> 
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
         <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.database.mariadb.MariaDbNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/brooklyncentral/brooklyn/raw/master/usage/launcher/src/test/resources/visitors-creation-script.sql</span>
    <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8192</span>
</code></pre>
</div>


<p>We've also brought in the <code>provisioning.properties</code> from the VM example earlier
so our database has 8GB RAM.
Any of those properties, including <code>imageId</code> and <code>user</code>, can be defined on a per-entity basis.</p>

<h3>Clusters and Policies</h3>

<p>Now let's bring the concept of the "cluster" back in.
We could wrap our appserver in the same <code>DynamicCluster</code> we used earlier,
although then we'd need to define and configure the load balancer.
But another blueprint, the <code>ControlledDynamicWebAppCluster</code>, does this for us.
It takes the same <code>memberSpec</code>, so we can build a fully functional elastic 3-tier
deployment of our <code>hello-world-sql</code> application as follows:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-clustered-w-db</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">initialSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="l-Scalar-Plain">memberSpec</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
        <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
        <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
          <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
              <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/brooklyncentral/brooklyn/raw/master/usage/launcher/src/test/resources/visitors-creation-script.sql</span>
</code></pre>
</div>


<p>This sets up Nginx as the controller by default, but that can be configured
using the <code>controllerSpec</code> key. In fact, JBoss is the default appserver,
and because configuration in Brooklyn is inherited by default,
the same blueprint can be expressed more concisely as:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-clustered-w-db-concise</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">initialSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
           <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/brooklyncentral/brooklyn/raw/master/usage/launcher/src/test/resources/visitors-creation-script.sql</span>
</code></pre>
</div>


<p>The other nicety supplied by the <code>ControlledDynamicWebAppCluster</code> blueprint is that
it aggregates sensors from the appserver, so we have access to things like
<code>webapp.reqs.perSec.windowed.perNode</code>.
These are convenient for plugging in to policies!
We can set up our blueprint to do autoscaling based on requests per second
(keeping it in the range 10..100, with a maximum of 5 appserver nodes)
as follows:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-policy</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">initialSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
  <span class="l-Scalar-Plain">memberSpec</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war</span>
        <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
        <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
          <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
              <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">policyType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.policy.autoscaling.AutoScalerPolicy</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">metric</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;brooklyn.entity.webapp.DynamicWebAppCluster&quot;, &quot;webapp.reqs.perSec.windowed.perNode&quot;)</span>
      <span class="l-Scalar-Plain">metricLowerBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">metricUpperBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
      <span class="l-Scalar-Plain">minPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">maxPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/brooklyncentral/brooklyn/raw/master/usage/launcher/src/test/resources/visitors-creation-script.sql</span>
</code></pre>
</div>


<p>Use your favorite load-generation tool (<code>jmeter</code> is one good example) to send a huge
volume of requests against the server and see the policies kick in to resize it.</p>

<h2>New Custom Entities</h2>

<p>So far we've covered how to configure and compose entities.
There's a large library of blueprints available, but
there are also times when you'll want to write your own.</p>

<p>For complex use cases, you can write JVM, but for many common situations,
some of the highly-configurable blueprints make it easy to write in YAML,
including <code>bash</code> and Chef.</p>

<h3>Vanilla Software using <code>bash</code></h3>

<p>The following blueprint shows how a simple script can be embedded in the YAML
(the <code>|</code> character is special YAML which makes it easier to insert multi-line text):</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.basic.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
</code></pre>
</div>


<p>This starts a simple <code>nc</code> listener on port 4321 which will respond <code>hello</code> to the first
session which connects to it. Test it by running <code>telnet localhost 4321</code>.</p>

<p>This is just a simple script, but it shows how any script can be easily embedded here,
including a script to download and run other artifacts.
Many artifacts are already packaged such that they can be downloaded and launched
with a simple script, and <code>VanillaSoftwareProcess</code> can also be used for them.
We can specify a <code>download.url</code> which downloads artifacts (unpacking TAR, TGZ, and ZIP archives)
before running <code>launch.command</code> relative to where that file is installed (or unpacked),
with <code>./start.sh</code> being the default <code>launch.command</code>.</p>

<p>So if we create a file <code>/tmp/netcat-server.tgz</code> containing just <code>start.sh</code> in the root
which consists of the two lines in the previous example,
we can instead write our example as:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Example From File</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.basic.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">download.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">file:///tmp/netcat-server.tgz</span>
</code></pre>
</div>


<p>The one requirement of the script is that it store the process ID (PID) in the file
pointed to by <code>$PID_FILE</code>, hence the second line of the script.
This is because Brooklyn wants to monitor the services under management.
(There are other options, as documented on the Javadoc of the <code>VanillaSoftwareProcess</code> class.)
And indeed, once you've run one <code>telnet</code> to the server, you'll see that the
service has gone "on fire" in Brooklyn -- because the <code>nc</code> process has stopped.</p>

<p>Besides detecting this failure, Brooklyn policies can be added to the YAML to take appropriate
action. A simple recovery here might just be to restart the process:</p>

<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server with Restart</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.basic.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">policyType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.policy.ha.ServiceFailureDetector</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># wait 15s after service fails before propagating failure</span>
      <span class="l-Scalar-Plain">serviceFailedStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15s</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">policyType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.policy.ha.ServiceRestarter</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># repeated failures in a time window can cause the restarter to abort,</span>
      <span class="c1"># propagating the failure; a time window of 0 will mean it always restarts!</span>
      <span class="l-Scalar-Plain">failOnRecurringFailuresInThisDuration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</code></pre>
</div>


<p>Autonomic management in Brooklyn often follows the principle that complex behaviours emerge
from composing simple policies.
The blueprint above uses one policy to triggering a failure sensor when the service is down,
and another responds to such failures by restarting the service.
This makes it easy to configure various aspects, such as to delay to see if the service itself recovers
(which here we've set to 15 seconds) or to bail out on multiple failures within a time window (which again we are not doing).
Running with this blueprint, you'll see that the service shows as on fire for 15s after a <code>telnet</code>,
before the policy restarts it.</p>

<p>This of course is a simple example, but it shows many of the building blocks used in real-world blueprints,
and how often they can be easily described and combined in Brooklyn YAML blueprints.</p>

<!--
TODO building up children entities

TODO adding sensors and effectors
-->




<!--

### Using Chef Recipes

TODO

-->


<h3>More Information</h3>

<p>Plenty of examples of blueprints exist in the Brooklyn codebase,
so a good starting point is to <a href="/v/0.7.0-SNAPSHOT/dev/code/index.html"><code>git clone</code></a> it
and search for <code>*.yaml</code> files therein.</p>

<p>Brooklyn lived as a Java framework for many years before we felt confident
to make a declarative front-end, so you can do pretty much anything you want to
by dropping to the JVM. Information on that is available:
* in the <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html">user guide</a>,
* through a <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/archetype.html">Maven archetype</a>,
* in the <a href="https://github.com/brooklyncentral/brooklyn">codebase</a>,
* and in plenty of <a href="/v/0.7.0-SNAPSHOT/use/examples/index.html">examples</a>.</p>

<p>You can also come talk to us, on IRC (#brooklyncentral on Freenode) or
any of the usual <a href="/v/0.7.0-SNAPSHOT/meta/contact.html">hailing frequencies</a>,
as these documents are a work in progress.</p>


        </div><!--maincontent-->
        
      <div id="sidebar">
      


  






<div id="sidebar_toc">

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/v/0.7.0-SNAPSHOT/start/index.html"><div class="toc-1-item">Start</div></a>
  
      </div>

    
    
    
	  <div class="toc-1 toc-active">
  
	    <a href="/v/0.7.0-SNAPSHOT/use/guide/index.html"><div class="toc-1-item toc-1-header ">User Guide</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/quickstart/index.html"><div class="toc-2-item">Quick Start</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 toc-active">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/basic-concepts.html"><div class="toc-2-item toc-2-header">Defining Applications</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/basic-concepts.html"><div class="toc-3-item">Basic Concepts</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/advanced-concepts.html"><div class="toc-3-item">Advanced Concepts</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/common-usage.html"><div class="toc-3-item">Common Usage</div></a>
              </div>
        
            
              <div class="toc-3 toc-active">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/creating-yaml.html"><div class="toc-3-item toc-active">YAML Blueprints</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/deploying-yaml.html"><div class="toc-3-item">Deploying YAML</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/yaml-reference.html"><div class="toc-3-item">YAML Reference</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/defining-applications/archetype.html"><div class="toc-3-item">Maven Archetype</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html"><div class="toc-2-item toc-2-header">Management</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#introduction"><div class="toc-3-item">Introduction</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#startup-config"><div class="toc-3-item">Startup Configuration</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#cli"><div class="toc-3-item">Command Line Interface</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#console"><div class="toc-3-item">Management Web Console</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#observation-other"><div class="toc-3-item">Observation APIs</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#distributed-management"><div class="toc-3-item">Distributed Management</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#resilience"><div class="toc-3-item">Resilience</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#key-apis"><div class="toc-3-item">Key APIs</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/management/index.html#sensors-and-effectors"><div class="toc-3-item">Sensors and Effectors</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/policies/index.html"><div class="toc-2-item toc-2-header">Policies</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/policies/index.html#introduction"><div class="toc-3-item">Introduction</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/policies/index.html#writing-policies"><div class="toc-3-item">Writing Policies</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/policies/index.html#off-the-shelf-policies"><div class="toc-3-item">Off-the-Shelf Policies</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/policies/index.html#implementing-policies"><div class="toc-3-item">Implementing Policies</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html"><div class="toc-2-item toc-2-header">Custom Entities</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#entity-lifestyle"><div class="toc-3-item">Entity Lifecycle</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#implementation-classes"><div class="toc-3-item">What to Extend</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#configuration"><div class="toc-3-item">Configuration</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#implementing-sensors"><div class="toc-3-item">Implementing Sensors</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#implementing-effectors"><div class="toc-3-item">Implementing Effectors</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/entities/index.html#testing"><div class="toc-3-item">Testing</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html"><div class="toc-2-item toc-2-header">Extras</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html#web"><div class="toc-3-item">Web</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html#database"><div class="toc-3-item">Database</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html#nosql"><div class="toc-3-item">NoSQL</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html#messaging"><div class="toc-3-item">Messaging</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/guide/extras/index.html#provisioning"><div class="toc-3-item">Provisioning</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/v/0.7.0-SNAPSHOT/start/index.html"><div class="toc-1-item toc-1-header ">Elsewhere</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/examples/index.html"><div class="toc-2-item toc-2-header">Examples</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/examples/webcluster/index.html"><div class="toc-3-item">Elastic Web Cluster</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/examples/global-web-fabric/index.html"><div class="toc-3-item">Global Web Fabric</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/examples/whirrhadoop/index.html"><div class="toc-3-item">Whirr Hadoop Cluster</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/examples/messaging/index.html"><div class="toc-3-item">Publish-Subscribe Messaging</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/use/examples/nosql-cassandra/index.html"><div class="toc-3-item">Cassandra Cluster</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/use/api/index.html"><div class="toc-2-item">API Reference</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/dev/code/index.html"><div class="toc-2-item toc-2-header">Contributing</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/code/index.html"><div class="toc-3-item">The Code</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/build/index.html"><div class="toc-3-item">Build and Test</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/tips/index.html"><div class="toc-3-item">Tips and Tricks</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/wishlist.html"><div class="toc-3-item">Wishlist</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/links.html"><div class="toc-3-item">Links</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/v/0.7.0-SNAPSHOT/dev/how-to-contrib.html"><div class="toc-3-item">How to Contribute</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/v/0.7.0-SNAPSHOT/license/index.html"><div class="toc-2-item">License</div></a>
      
          </div>
    
        </div>
  
      </div>
 
</div>
<br/>


      </div>

    </div><!--contentcontainer-->
        
    <div id="footer">
        <p id="copyright">
            <b>brooklyn is distributed under the Apache License v2.0.</b><br/>
            brooklyn is a registered trademark of Cloudsoft Corporation.<br/>
            &copy; 2013 Cloudsoft Corporation.
        </p>
    </div><!--footer -->

</div><!--container-->

</body>
</html>
